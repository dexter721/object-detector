<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>AI Object Detector with Thai Voice</title>
  <style>
    body { text-align: center; font-family: sans-serif; margin: 0; padding: 10px; }
    video { width: 90%; max-width: 640px; margin: 10px auto; display: block; }
    canvas { display: none; }
    select, button, input[type=range] {
      margin: 5px; padding: 5px; font-size: 16px;
    }
    #mirrorToggle { display: none; }
  </style>
</head>
<body>
  <h1>ระบบช่วยเรียนรู้วัตถุด้วยเสียง (AI)</h1>
  <video id="video" autoplay playsinline></video>
  <br />
  <select id="cameraSelect"></select>
  <button onclick="toggleMirror()">เปลี่ยนโหมดกระจก</button>
  <button onclick="toggleDetection()">เลิกตรวจจับ</button>
  <button onclick="toggleSpeech()">ปิดเสียง</button>
  <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="1" />
  <canvas id="canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const cameraSelect = document.getElementById('cameraSelect');
    const volumeControl = document.getElementById('volumeControl');

    let model;
    let stream;
    let currentDeviceId = null;
    let isDetecting = true;
    let isSpeaking = true;
    let mirrorMode = false;
    let lastSpoken = '';
    let lastTime = 0;

    const labelDict = {
      "chair": "เก้าอี้",
      "couch": "โซฟา",
      "bed": "เตียง",
      "dining table": "โต๊ะ",
      "tv": "ทีวี",
      "cell phone": "โทรศัพท์",
      "book": "หนังสือ",
      "bottle": "ขวด",
      "cup": "ถ้วย",
      "bowl": "ชาม",
      "remote": "รีโมท",
      "mouse": "เมาส์",
      "keyboard": "คีย์บอร์ด",
      "laptop": "โน้ตบุ๊ก",
      "microwave": "ไมโครเวฟ",
      "sports ball": "ลูกบอล",
      "scissors": "กรรไกร",
      "backpack": "กระเป๋า",
      "teddy bear": "ตุ๊กตา",
      "pen": "ปากกา",
      "pencil": "ดินสอ",
      "eraser": "ยางลบ",
      "headphones": "หูฟัง",
      "box": "กล่อง",
      "apple": "แอปเปิล",
      "banana": "กล้วย",
      "person": "คน"
    };

    const speak = (text) => {
      if (!isSpeaking) return;
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'th-TH';
      utter.volume = parseFloat(volumeControl.value);
      speechSynthesis.speak(utter);
    };

    async function initCamera(deviceId = null) {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      const constraints = {
        audio: false,
        video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' }
      };

      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      video.style.transform = mirrorMode ? 'scaleX(-1)' : 'scaleX(1)';
    }

    function toggleMirror() {
      mirrorMode = !mirrorMode;
      video.style.transform = mirrorMode ? 'scaleX(-1)' : 'scaleX(1)';
    }

    function toggleDetection() {
      isDetecting = !isDetecting;
      alert(isDetecting ? "เริ่มตรวจจับแล้ว" : "หยุดตรวจจับแล้ว");
    }

    function toggleSpeech() {
      isSpeaking = !isSpeaking;
      alert(isSpeaking ? "เปิดเสียงแล้ว" : "ปิดเสียงแล้ว");
    }

    async function populateCameraOptions() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      cameraSelect.innerHTML = '';
      devices.filter(d => d.kind === 'videoinput').forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `กล้อง ${cameraSelect.length + 1}`;
        cameraSelect.appendChild(option);
      });
      if (cameraSelect.options.length > 0) {
        currentDeviceId = cameraSelect.options[0].value;
        cameraSelect.value = currentDeviceId;
      }
    }

    cameraSelect.onchange = async () => {
      currentDeviceId = cameraSelect.value;
      await initCamera(currentDeviceId);
    };

    async function detectFrame() {
      if (!model || !isDetecting) {
        requestAnimationFrame(detectFrame);
        return;
      }

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const predictions = await model.detect(canvas);

      const now = Date.now();
      for (const pred of predictions) {
        const label = pred.class;
        if (labelDict[label]) {
          if (label !== lastSpoken || now - lastTime > 5000) {
            lastSpoken = label;
            lastTime = now;
            speak(labelDict[label]);
            break;
          }
        }
      }

      requestAnimationFrame(detectFrame);
    }

    async function init() {
      await populateCameraOptions();
      await initCamera(currentDeviceId);
      model = await cocoSsd.load();
      detectFrame();
    }

    window.onload = () => {
      // ปลุกระบบพูดเพื่อไม่ให้บล็อกเสียงในบางเบราว์เซอร์
      document.body.addEventListener('click', () => {
        const dummy = new SpeechSynthesisUtterance('');
        dummy.lang = 'th-TH';
        speechSynthesis.speak(dummy);
      }, { once: true });

      init();
    };
  </script>
</body>
</html>

let lastSpoken = '';
let lastSpokenTime = 0;
let lastDetectedObject = '';

function speak(text) {
  const now = Date.now();

  // ถ้าวัตถุไม่เปลี่ยน หรือยังไม่ครบ 10 วินาที ไม่พูดซ้ำ
  if (text === lastSpoken && (now - lastSpokenTime) < 10000) {
    return;
  }
  if (speechSynthesis.speaking) {
    // ถ้าเสียงกำลังพูดอยู่ รอจบก่อน (ไม่ cancel)
    return;
  }
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "th-TH";
  speechSynthesis.speak(utter);

  lastSpoken = text;
  lastSpokenTime = now;
}

async function detectFrame() {
  if (!detecting) return;

  const predictions = await model.detect(video);

  if (predictions.length > 0) {
    const name = predictions[0].class;

    if (name !== "person") {
      if (name !== lastDetectedObject) {
        lastDetectedObject = name;
        const thaiName = labelDict[name] || name;
        label.textContent = `พบวัตถุ: ${thaiName}`;
        speak(thaiName);
      } else {
        speak(labelDict[name] || name);
      }
    } else {
      label.textContent = "พบวัตถุ: คน (ไม่พูด)";
      lastDetectedObject = '';
    }
  } else {
    label.textContent = "ไม่พบวัตถุ";
    lastDetectedObject = '';
  }

  requestAnimationFrame(detectFrame);
}

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>AI Object Detector with Voice (Thai Only)</title>
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
    }
    video {
      border: 2px solid black;
      width: 80%;
      max-width: 640px;
      margin: 10px auto;
    }
    #controls {
      margin-top: 20px;
    }
    #volumeValue {
      font-weight: bold;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>ระบบช่วยเรียนรู้วัตถุสำหรับเด็ก</h1>
  <video id="video" autoplay muted playsinline></video>
  <div id="controls">
    <button onclick="toggleCamera()">เปิด/ปิด กล้อง</button><br><br>
    <label for="volumeRange">ระดับเสียง:</label>
    <input type="range" id="volumeRange" min="0" max="1" step="0.01" value="1" onchange="setVolume(this.value)">
    <span id="volumeValue">100%</span>
  </div>

  <!-- โหลดโมเดล -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

  <script>
    let video = document.getElementById('video');
    let model;
    let isCameraOn = false;
    let volume = 1;
    let lastSpoken = {};
    const speakCooldown = 3000; // 3 วินาที

    const THAI_LABELS = {
      'chair': 'เก้าอี้',
      'bed': 'เตียง',
      'couch': 'โซฟา',
      'tv': 'ทีวี',
      'cell phone': 'โทรศัพท์',
      'bottle': 'ขวด',
      'book': 'หนังสือ',
      'cup': 'แก้ว',
      'bowl': 'ถ้วย',
      'dining table': 'โต๊ะ',
      'remote': 'รีโมท',
      'keyboard': 'คีย์บอร์ด',
      'mouse': 'เมาส์',
      'laptop': 'โน้ตบุ๊ก',
      'microwave': 'ไมโครเวฟ',
      'oven': 'เตาอบ',
      'sink': 'อ่างล้างจาน',
      'refrigerator': 'ตู้เย็น',
      'backpack': 'กระเป๋า',
      'handbag': 'กระเป๋าถือ',
      'suitcase': 'กระเป๋าเดินทาง',
      'scissors': 'กรรไกร',
      'toothbrush': 'แปรงสีฟัน',
      'hair drier': 'ไดร์เป่าผม',
      'toilet': 'โถส้วม',
      'mirror': 'กระจก',
      'pen': 'ปากกา',
      'pencil': 'ดินสอ',
      'eraser': 'ยางลบ',
      'headphones': 'หูฟัง',
      'box': 'กล่อง',
      'computer': 'คอมพิวเตอร์',
      'tablet': 'แท็บเล็ต',
      'printer': 'เครื่องพิมพ์',
      'microphone': 'ไมโครโฟน',
      'charger': 'สายชาร์จ',
      'power bank': 'พาวเวอร์แบงก์',
      'fork': 'ส้อม',
      'spoon': 'ช้อน',
      'plate': 'จาน',
      'pillow': 'หมอน',
      'doll': 'ตุ๊กตา',
      'ball': 'ลูกบอล',
      'toy car': 'รถของเล่น',
      'robot': 'หุ่นยนต์',
      'board': 'กระดาน',
      'pan': 'กระทะ',
      'pot': 'หม้อ',
      'notebook': 'สมุด',
      // เพิ่มได้อีก
    };

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'th-TH';
      utterance.volume = volume;
      speechSynthesis.speak(utterance);
    }

    function setVolume(val) {
      volume = parseFloat(val);
      document.getElementById('volumeValue').innerText = Math.round(volume * 100) + "%";
    }

    function toggleCamera() {
      if (isCameraOn) {
        stopCamera();
      } else {
        startCamera();
      }
    }

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        video.srcObject = stream;
        isCameraOn = true;
        detectFrame();
      }).catch(err => {
        console.error("ไม่สามารถเปิดกล้องได้", err);
      });
    }

    function stopCamera() {
      let stream = video.srcObject;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.srcObject = null;
      isCameraOn = false;
    }

    async function detectFrame() {
      if (!model || !isCameraOn) return;
      model.detect(video).then(predictions => {
        predictions.forEach(prediction => {
          const label = prediction.class;
          const now = Date.now();
          const thaiLabel = THAI_LABELS[label];
          if (thaiLabel) {
            if (!lastSpoken[label] || now - lastSpoken[label] > speakCooldown) {
              speak(thaiLabel);
              lastSpoken[label] = now;
            }
          }
        });
        if (isCameraOn) {
          requestAnimationFrame(detectFrame);
        }
      });
    }

    // โหลดโมเดลแล้วเริ่มกล้องทันที
    cocoSsd.load().then(loadedModel => {
      model = loadedModel;
      console.log("โหลดโมเดลเสร็จแล้ว");
      startCamera(); // เปิดกล้องอัตโนมัติเมื่อโหลดเสร็จ
    });
  </script>
</body>
</html>
